name: Sync Files

on:
  push:
    branches: [main]
    paths:
      - 'repository-files/**'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no changes)'
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  sync:
    name: Sync to Org Repos
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install vendor-connectors
        run: pip install vendor-connectors

      - name: Sync files to org repos
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          DRY_RUN: ${{ inputs.dry_run }}
          ORG: arcade-cabinet
        run: |
          echo "Syncing repository-files to all $ORG repos..."
          
          # Get list of repos using vendor-connectors CLI
          REPOS=$(vendor-connectors call github list_repositories --github_owner "$ORG" --jq '.[] | select(.archived == false) | .name')
          
          for repo in $REPOS; do
            # Skip control-center itself
            [[ "$repo" == "control-center" ]] && continue
            
            echo "ğŸ“¦ $ORG/$repo"
            
            # PHASE 1: Always Sync (Overwrite)
            find repository-files/always-sync -type f | while read -r file; do
              rel_path="${file#repository-files/always-sync/}"
              
              if [[ "$DRY_RUN" == "true" ]]; then
                echo "  Would sync (always): $rel_path"
              else
                content=$(cat "$file")
                vendor-connectors call github update_repository_file \
                  --github_owner "$ORG" \
                  --github_repo "$repo" \
                  --file_path "$rel_path" \
                  --file_data "$content" \
                  --msg "chore(sync): update $rel_path from control-center" > /dev/null 2>&1 && echo "  âœ… $rel_path" || echo "  âŒ $rel_path"
              fi
            done
            
            # PHASE 2: Initial Sync (Create if missing)
            if [ -d "repository-files/initial-only" ]; then
              find repository-files/initial-only -type f | while read -r file; do
                rel_path="${file#repository-files/initial-only/}"
                # Remove first level directory (e.g., python/, node/) for destination
                dest_path=$(echo "$rel_path" | cut -d/ -f2-)
                
                if [[ "$DRY_RUN" == "true" ]]; then
                  echo "  Would sync (initial): $dest_path"
                else
                  # Only sync if file doesn't exist
                  if ! gh api "repos/$ORG/$repo/contents/$dest_path" --jq '.name' >/dev/null 2>&1; then
                    content=$(cat "$file")
                    vendor-connectors call github update_repository_file \
                      --github_owner "$ORG" \
                      --github_repo "$repo" \
                      --file_path "$dest_path" \
                      --file_data "$content" \
                      --msg "chore(init): create $dest_path from control-center" > /dev/null 2>&1 && echo "  ğŸ†• $dest_path" || echo "  âŒ $dest_path"
                  fi
                fi
              done
            fi
          done
