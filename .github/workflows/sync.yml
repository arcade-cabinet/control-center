name: Sync Files

on:
  push:
    branches: [main]
    paths:
      - 'repository-files/**'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no changes)'
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  sync:
    name: Sync to Org Repos
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Sync files to org repos
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          DRY_RUN: ${{ inputs.dry_run }}
          ORG: arcade-cabinet
        run: |
          echo "Syncing repository-files to all $ORG repos..."
          
          # Get list of repos
          repos=$(gh repo list "$ORG" --limit 100 --json name,isArchived --jq '.[] | select(.isArchived == false) | .name')
          
          for repo in $repos; do
            # Skip control-center itself and .github repo
            [[ "$repo" == "control-center" ]] && continue
            [[ "$repo" == ".github" ]] && continue
            
            echo "ğŸ“¦ $ORG/$repo"
            
            # 1. Sync files from repository-files/always-sync (Overwrite)
            find repository-files/always-sync -type f | while read -r file; do
              rel_path="${file#repository-files/always-sync/}"
              
              if [[ "$DRY_RUN" == "true" ]]; then
                echo "  [ALWAYS] Would sync: $rel_path"
              else
                content=$(base64 -w0 "$file")
                sha=$(gh api "repos/$ORG/$repo/contents/$rel_path" --jq '.sha' 2>/dev/null || echo "")
                
                if [ -n "$sha" ]; then
                  # Compare current content with new content to avoid empty commits
                  current_content=$(gh api "repos/$ORG/$repo/contents/$rel_path" --jq '.content' | tr -d '\n')
                  if [ "$current_content" == "$content" ]; then
                    echo "  âœ… $rel_path (unchanged)"
                    continue
                  fi

                  gh api -X PUT "repos/$ORG/$repo/contents/$rel_path" \
                    -f message="chore: sync $rel_path from control-center" \
                    -f content="$content" \
                    -f sha="$sha" >/dev/null && echo "  âœ… $rel_path (updated)" || echo "  âŒ $rel_path"
                else
                  gh api -X PUT "repos/$ORG/$repo/contents/$rel_path" \
                    -f message="chore: sync $rel_path from control-center" \
                    -f content="$content" >/dev/null && echo "  âœ… $rel_path (created)" || echo "  âŒ $rel_path"
                fi
              fi
            done

            # 2. Sync files from repository-files/initial-only (Only if not exists)
            if [ -d "repository-files/initial-only" ]; then
              find repository-files/initial-only -type f | while read -r file; do
                rel_path="${file#repository-files/initial-only/}"
                
                if [[ "$DRY_RUN" == "true" ]]; then
                  echo "  [INITIAL] Would sync if missing: $rel_path"
                else
                  # Check if file exists
                  sha=$(gh api "repos/$ORG/$repo/contents/$rel_path" --jq '.sha' 2>/dev/null || echo "")
                  
                  if [ -z "$sha" ]; then
                    content=$(base64 -w0 "$file")
                    gh api -X PUT "repos/$ORG/$repo/contents/$rel_path" \
                      -f message="chore: initial sync $rel_path from control-center" \
                      -f content="$content" >/dev/null && echo "  ğŸ†• $rel_path (initial)" || echo "  âŒ $rel_path"
                  else
                    echo "  â© $rel_path (exists, skipping initial-only)"
                  fi
                fi
              done
            fi
          done
