name: Ecosystem Sync

on:
  push:
    branches: [main]
    paths:
      - 'repository-files/**'
      - 'repo-config.json'
      - '.github/sync-always.yml'
      - '.github/sync-initial.yml'
      - 'scripts/**'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no changes)'
        type: boolean
        default: false
      sync_secrets:
        description: 'Sync secrets'
        type: boolean
        default: false
      configure_repos:
        description: 'Configure repo settings'
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  # =============================================================================
  # Validate configuration before any sync
  # =============================================================================
  validate:
    name: üîç Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate all configs
        run: |
          chmod +x scripts/validate-config
          ./scripts/validate-config --verbose

  # =============================================================================
  # Phase 1: Initial Sync
  # Creates files ONLY if they don't exist
  # =============================================================================
  phase-1-initial:
    name: üì¶ Phase 1 - Initial Sync
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Initial file sync (create missing only)
        uses: BetaHuhn/repo-file-sync-action@v1
        with:
          GH_PAT: ${{ secrets.CI_GITHUB_TOKEN }}
          CONFIG_PATH: .github/sync-initial.yml
          DRY_RUN: ${{ inputs.dry_run == true }}
          SKIP_PR: true
          COMMIT_PREFIX: 'chore(init):'
          GIT_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_USERNAME: github-actions[bot]

  # =============================================================================
  # Phase 2: Always Sync
  # Overwrites files with latest shared configs
  # =============================================================================
  phase-2-always:
    name: üîÑ Phase 2 - Always Sync
    needs: phase-1-initial
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Always file sync (overwrite)
        uses: BetaHuhn/repo-file-sync-action@v1
        with:
          GH_PAT: ${{ secrets.CI_GITHUB_TOKEN }}
          CONFIG_PATH: .github/sync-always.yml
          DRY_RUN: ${{ inputs.dry_run == true }}
          SKIP_PR: true
          COMMIT_PREFIX: 'chore(sync):'
          GIT_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_USERNAME: github-actions[bot]

  # =============================================================================
  # Standardize Repository Settings & Secrets
  # =============================================================================
  manage-org:
    name: üõ†Ô∏è Manage Org
    needs: phase-2-always
    runs-on: ubuntu-latest
    if: always() && (needs.phase-2-always.result == 'success' || needs.phase-2-always.result == 'skipped')
    steps:
      - uses: actions/checkout@v4
      
      - name: Sync Secrets
        if: github.event_name == 'push' || inputs.sync_secrets == true
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          CI_GITHUB_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          GOOGLE_JULES_API_KEY: ${{ secrets.GOOGLE_JULES_API_KEY }}
        run: |
          chmod +x scripts/sync-secrets
          ./scripts/sync-secrets ${{ inputs.dry_run == true && '--dry-run' || '' }} --all

      - name: Configure Repos
        if: github.event_name == 'push' || inputs.configure_repos == true
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          chmod +x scripts/configure-repos
          ./scripts/configure-repos ${{ inputs.dry_run == true && '--dry-run' || '' }}
